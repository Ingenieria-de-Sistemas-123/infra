# Stack local para desarrollo sin HTTPS/Certbot.
# Objetivo: levantar todos los servicios con puertos mapeados al host para facilitar el debugging.
# Ventajas:
# - Simplicidad: no requiere certificados ni dominios.
# - Observabilidad local: puedes pegarle directo a cada servicio por su puerto.
# - Opción: usar NGINX como reverse proxy HTTP (sin TLS) o acceder directo por puertos.

name: infra-local

services:
  # Bases de datos
  permission-db:
    image: postgres:16
    container_name: permission-db-local
    environment:
      POSTGRES_DB: ${PERMISSION_DB_NAME:-permission}
      POSTGRES_USER: ${PERMISSION_DB_USER:-permission}
      POSTGRES_PASSWORD: ${PERMISSION_DB_PASSWORD:-permission}
    ports:
      - "15432:5432" # host:container para debug local
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  snippet-db:
    image: postgres:16-alpine
    container_name: snippet-db-local
    environment:
      POSTGRES_DB: ${SNIPPET_DB_NAME:-snippet}
      POSTGRES_USER: ${SNIPPET_DB_USER:-snippet}
      POSTGRES_PASSWORD: ${SNIPPET_DB_PASSWORD:-snippet}
    ports:
      - "25432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  # Servicios backend
  permission-service:
    image: ghcr.io/ingenieria-de-sistemas-123/permission-service:dev
    container_name: permission-service-local
    depends_on:
      permission-db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: ${PERMISSION_DB_URL:-jdbc:postgresql://permission-db:5432/${PERMISSION_DB_NAME:-permission}}
      SPRING_DATASOURCE_USERNAME: ${PERMISSION_DB_USER:-permission}
      SPRING_DATASOURCE_PASSWORD: ${PERMISSION_DB_PASSWORD:-permission}
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: ${AUTH0_ISSUER_URI:-}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE:-https://snippet-api}
    ports:
      - "18080:8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep UP || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 15s

  language-service:
    image: ghcr.io/ingenieria-de-sistemas-123/language-service:dev
    container_name: language-service-local
    environment:
      SPRING_PROFILES_ACTIVE: docker
    ports:
      - "18082:8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep UP || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 15s

  snippet-service:
    image: ghcr.io/ingenieria-de-sistemas-123/snippet-service:dev
    container_name: snippet-service-local
    depends_on:
      snippet-db:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${SNIPPET_DB_URL:-jdbc:postgresql://snippet-db:5432/${SNIPPET_DB_NAME:-snippet}}
      SPRING_DATASOURCE_USERNAME: ${SNIPPET_DB_USER:-snippet}
      SPRING_DATASOURCE_PASSWORD: ${SNIPPET_DB_PASSWORD:-snippet}
      LANGUAGE_BASE_URL: ${LANGUAGE_BASE_URL:-http://language-service:8080}
    ports:
      - "18081:8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep UP || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 15s

  # UI
  printscript-ui:
    image: ghcr.io/ingenieria-de-sistemas-123/printscript-ui:dev-latest
    container_name: printscript-ui-local
    environment:
      VITE_AUTH0_DOMAIN: ${VITE_AUTH0_DOMAIN:-dev-7t5evioih4aq30t7.us.auth0.com}
      VITE_AUTH0_CLIENT_ID: ${VITE_AUTH0_CLIENT_ID:-VYNjhtO7lzwE7030uJyYaas6buopgtGg}
      VITE_AUTH0_AUDIENCE: ${VITE_AUTH0_AUDIENCE:-https://snippet-api}
      VITE_AUTH0_CALLBACK_URL: ${VITE_AUTH0_CALLBACK_URL:-http://localhost:3000}
      VITE_PERMISSION_BASE_URL: ${VITE_PERMISSION_BASE_URL:-/api}
    ports:
      - "3000:80"  # UI accesible en http://localhost:3000

  # Reverse proxy HTTP (opcional en local).
  # Si prefieres acceder por puertos directos, puedes comentar este servicio.
  reverse-proxy:
    image: nginx:alpine
    container_name: reverse-proxy-local
    depends_on:
      permission-service:
        condition: service_healthy
      snippet-service:
        condition: service_healthy
      language-service:
        condition: service_healthy
      printscript-ui:
        condition: service_started
    ports:
      - "8080:80"  # proxy en http://localhost:8080
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
      # En local, se ignora configuración SSL. Asegúrate que default.conf
      # no exija certificados al escuchar en 80.

networks:
  default:
    name: infra_local_default
    driver: bridge

