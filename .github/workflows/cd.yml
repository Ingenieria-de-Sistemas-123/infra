name: CD (infra)

on:
  push:
    branches: [ dev, main ]
  workflow_dispatch:

concurrency:
  group: cd-infra-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy_to_vm:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script_stop: true
          command_timeout: 20m
          script: |
            set -euo pipefail

            cd "${{ secrets.DEPLOY_WORKDIR }}"

            BRANCH="${GITHUB_REF_NAME}"
            if [ "$BRANCH" = "main" ]; then
              COMPOSE_FILE="docker-compose.prod.yml"
              ENV_FILE=".env.prod"
            else
              COMPOSE_FILE="docker-compose.dev.yml"
              ENV_FILE=".env.dev"
            fi

            echo "[cd] using compose file: $COMPOSE_FILE"
            test -f "$COMPOSE_FILE" || { echo "::error file=$COMPOSE_FILE::compose file not found"; exit 1; }

            echo "[cd] sync infra repo to $BRANCH"
            git fetch --all --prune
            git reset --hard "origin/$BRANCH"

            echo "[cd] writing $ENV_FILE from secrets"
            : > "$ENV_FILE"
            echo "DB_NAME=${{ secrets.DB_NAME }}" >> "$ENV_FILE"
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> "$ENV_FILE"
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> "$ENV_FILE"
            echo "DB_PERMISSION_NAME=${{ secrets.DB_PERMISSION_NAME }}" >> "$ENV_FILE"
            echo "DB_PERMISSION_USER=${{ secrets.DB_PERMISSION_USER }}" >> "$ENV_FILE"
            echo "DB_PERMISSION_PASSWORD=${{ secrets.DB_PERMISSION_PASSWORD }}" >> "$ENV_FILE"
            echo "SPRING_DATASOURCE_URL_SNIPPET=jdbc:postgresql://snippet-db:5432/${{ secrets.DB_NAME }}" >> "$ENV_FILE"
            echo "SPRING_DATASOURCE_USERNAME_SNIPPET=${{ secrets.DB_USERNAME }}" >> "$ENV_FILE"
            echo "SPRING_DATASOURCE_PASSWORD_SNIPPET=${{ secrets.DB_PASSWORD }}" >> "$ENV_FILE"
            echo "SPRING_DATASOURCE_URL_PERMISSIONDB=jdbc:postgresql://permission-db:5432/${{ secrets.DB_PERMISSION_NAME }}" >> "$ENV_FILE"
            echo "SPRING_DATASOURCE_USERNAME_PERMISSIONDB=${{ secrets.DB_PERMISSION_USER }}" >> "$ENV_FILE"
            echo "SPRING_DATASOURCE_PASSWORD_PERMISSIONDB=${{ secrets.DB_PERMISSION_PASSWORD }}" >> "$ENV_FILE"
            echo "SPRING_DATASOURCE_URL=jdbc:postgresql://permission-db:5432/${{ secrets.DB_PERMISSION_NAME }}" >> "$ENV_FILE"
            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.DB_PERMISSION_USER }}" >> "$ENV_FILE"
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PERMISSION_PASSWORD }}" >> "$ENV_FILE"
            echo "SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI=${{ secrets.AUTH0_ISSUER }}" >> "$ENV_FILE"
            echo "SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI=${{ secrets.AUTH0_ISSUER }}.well-known/jwks.json" >> "$ENV_FILE"
            echo "AUTH0_AUDIENCE=${{ secrets.AUTH0_AUDIENCE }}" >> "$ENV_FILE"
            
            echo "[cd] login to ghcr.io"
            docker logout ghcr.io >/dev/null 2>&1 || true
            echo "${{ secrets.GH_PAT }}" | docker login ghcr.io -u "${{ secrets.GHCR_USER || github.actor }}" --password-stdin

            echo "[cd] deploy ($COMPOSE_FILE)"
            docker compose -f "$COMPOSE_FILE" pull
            
            # Validar configuración con el env file
            echo "[cd] compose config"
            docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" config
            
            # Levantar servicios
            docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" up -d --remove-orphans
            
            echo "[cd] wait for services"
            wait_up() {
              local name="$1" url="$2"
              echo "→ waiting $name at $url ..."
              for i in {1..40}; do
                if curl -fsS "$url" | grep -q '"status":"UP"'; then
                  echo "✓ $name UP"; return 0
                fi
                sleep 2
              done
              echo "::error::$name did not become UP"; return 1
            }

            if [ "$BRANCH" = "main" ]; then
              wait_up "reverse-proxy" "http://localhost/actuator/health"
            else
              wait_up "reverse-proxy-dev" "http://localhost/actuator/health"
            fi

            echo "[cd] state"
            docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" ps
            docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" logs --no-color --timestamps permission-db || true
            docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" logs --no-color --timestamps snippet-db || true
            docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" logs --no-color --timestamps permission-service || true
            docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" logs --no-color --timestamps snippet-service || true
            docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" logs --no-color --timestamps language-service || true
            
            echo "[cd] prune old images"
            docker image prune -f
