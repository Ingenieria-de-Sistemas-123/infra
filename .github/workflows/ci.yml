name: CI (infra)

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev, main ]

jobs:
  compose-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    env:
      COMPOSE_FILE: docker-compose.dev.yml
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preparar archivo de entorno (.env.ci.dev) sin exponer secrets
        run: |
          set -euo pipefail
          file=".env.ci.dev"
          : > "$file"

          # Fallbacks locales (CI) si no hay Secrets (evitan warnings)
          DB_PERMISSION_NAME="${{ secrets.DB_PERMISSION_NAME || 'permission_db' }}"
          DB_PERMISSION_USER="${{ secrets.DB_PERMISSION_USER || 'postgres' }}"
          DB_PERMISSION_PASSWORD="${{ secrets.DB_PERMISSION_PASSWORD || 'postgres' }}"
          DB_SNIPPET_NAME="${{ secrets.DB_NAME || 'snippet_db' }}"
          DB_SNIPPET_USERNAME="${{ secrets.DB_USERNAME || 'postgres' }}"
          DB_SNIPPET_PASSWORD="${{ secrets.DB_PASSWORD || 'postgres' }}"
          AUTH0_ISSUER="${{ secrets.AUTH0_ISSUER || 'https://example-tenant.auth0.com/' }}"
          AUTH0_AUDIENCE="${{ secrets.AUTH0_AUDIENCE || 'https://snippet-api' }}"

          {
            echo "DB_PERMISSION_NAME=${DB_PERMISSION_NAME}"
            echo "DB_PERMISSION_USER=${DB_PERMISSION_USER}"
            echo "DB_PERMISSION_PASSWORD=${DB_PERMISSION_PASSWORD}"
            echo "DB_SNIPPET_NAME=${DB_SNIPPET_NAME}"
            echo "DB_SNIPPET_USERNAME=${DB_SNIPPET_USERNAME}"
            echo "DB_SNIPPET_PASSWORD=${DB_SNIPPET_PASSWORD}"
            echo "SPRING_DATASOURCE_URL_PERMISSIONDB=jdbc:postgresql://permission-db:5432/${DB_PERMISSION_NAME}"
            echo "SPRING_DATASOURCE_USERNAME_PERMISSIONDB=${DB_PERMISSION_USER}"
            echo "SPRING_DATASOURCE_PASSWORD_PERMISSIONDB=${DB_PERMISSION_PASSWORD}"
            echo "SPRING_DATASOURCE_URL_SNIPPET=jdbc:postgresql://snippet-db:5432/${DB_SNIPPET_NAME}"
            echo "SPRING_DATASOURCE_USERNAME_SNIPPET=${DB_SNIPPET_USERNAME}"
            echo "SPRING_DATASOURCE_PASSWORD_SNIPPET=${DB_SNIPPET_PASSWORD}"
            echo "SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI=${AUTH0_ISSUER}"
            echo "AUTH0_AUDIENCE=${AUTH0_AUDIENCE}"
          } >> "$file"

          echo "Archivo .env.ci.dev generado."

      - name: Validar docker compose
        run: docker compose -f "$COMPOSE_FILE" --env-file .env.ci.dev config

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USER || github.actor }}
          password: ${{ secrets.GHCR_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Pull imágenes
        run: docker compose -f "$COMPOSE_FILE" --env-file .env.ci.dev pull

      - name: Levantar stack
        run: docker compose -f "$COMPOSE_FILE" --env-file .env.ci.dev up -d --remove-orphans

      - name: Esperar salud de contenedores (healthcheck vía Docker)
        run: |
          set -euo pipefail
          wait_health() {
            local name="$1"
            echo "→ esperando salud: $name"
            for i in $(seq 1 40); do
              status="$(docker inspect -f '{{ .State.Health.Status }}' "$name" 2>/dev/null || echo 'starting')"
              if [ "$status" = "healthy" ]; then
                echo "✓ $name healthy"
                return 0
              fi
              sleep 2
            done
            echo "::error::$name no alcanzó estado healthy"
            return 1
          }
          wait_health permission-db
          wait_health snippet-db
          wait_health permission-service
          wait_health snippet-service
          wait_health language-service

      - name: Mostrar estado (sin secretos)
        run: docker compose -f "$COMPOSE_FILE" --env-file .env.ci.dev ps

      - name: Logs en fallo
        if: failure()
        run: |
          docker compose -f "$COMPOSE_FILE" --env-file .env.ci.dev logs --no-color --timestamps permission-db || true
          docker compose -f "$COMPOSE_FILE" --env-file .env.ci.dev logs --no-color --timestamps snippet-db || true
          docker compose -f "$COMPOSE_FILE" --env-file .env.ci.dev logs --no-color --timestamps permission-service || true
          docker compose -f "$COMPOSE_FILE" --env-file .env.ci.dev logs --no-color --timestamps snippet-service || true
          docker compose -f "$COMPOSE_FILE" --env-file .env.ci.dev logs --no-color --timestamps language-service || true

      - name: Derribar stack
        if: always()
        run: docker compose -f "$COMPOSE_FILE" --env-file .env.ci.dev down -v

      - name: Borrar archivo temporal .env.ci.dev
        if: always()
        run: rm -f .env.ci.dev
